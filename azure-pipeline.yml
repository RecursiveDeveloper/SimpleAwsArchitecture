trigger:
  branches:
    include:
    - main
  paths:
    exclude:
    - azure-pipeline*.yml

parameters:
  - name: StackAction
    displayName: StackAction
    type: string
    default: Deploy
    values:
    - 'Deploy'
    - 'Destroy'
  - name: regionName
    displayName: regionName
    type: string
    default: 'us-east-1'

pool:
  vmImage: ubuntu-latest

variables:
  VpcStackName: 'VpcStack'
  SecurityGroupStackName: 'SgStack'
  AlbStackName: 'AlbStack'
  IamStackName: 'IamStack'
  S3BucketStackName: 'S3Stack'
  AsgStackName: 'AsgStack'
  S3BucketName: 'simpleawsarchitecture-artifacts'

  iacTemplatesPath: '$(System.DefaultWorkingDirectory)/cloudformation-templates'
  checkovReportPath: '$(System.DefaultWorkingDirectory)/checkov-report'
  checkovReportFormat: 'junitxml'
  checkovReportFile: 'checkov-report.$(checkov-report-format)'

jobs:
- ${{ if eq(parameters.StackAction, 'Deploy') }}:
  - template: 'azure-pipeline-templates/static-analysis.yml'
    parameters:
      iacTemplatesPath: ${{ variables.iacTemplatesPath }}
      StackAction: ${{ parameters.StackAction }}
      checkovReportPath: ${{ variables.checkovReportPath }}
      checkovReportFormat: ${{ variables.checkovReportFormat }}
      checkovReportFile: ${{ variables.checkovReportFile }}

  - job: ManualValidation
    displayName: Manual Validation
    dependsOn: CheckovScanner
    condition: succeeded()
    steps:
      - task: ManualValidation@0
        displayName: 'Manual Validation'
        inputs:
          instructions: 'Review the Static Code Analysis report and approve or reject the deployment.'
          onTimeout: 'reject'

  - template: 'azure-pipeline-templates/deploy-resources.yml'
    parameters:
      iacTemplatesPath: ${{ variables.iacTemplatesPath }}
      StackAction: ${{ parameters.StackAction }}
      regionName: ${{ parameters.regionName }}
      S3BucketStackName: ${{ variables.S3BucketStackName }}
      VpcStackName: ${{ variables.VpcStackName }}
      SecurityGroupStackName: ${{ variables.SecurityGroupStackName }}
      AlbStackName: ${{ variables.AlbStackName }}
      IamStackName: ${{ variables.IamStackName }}
      AsgStackName: ${{ variables.AsgStackName }}
      S3BucketName: ${{ variables.S3BucketName }}

- ${{ if eq(parameters.StackAction, 'Destroy') }}:
  - template: 'azure-pipeline-templates/destroy-resources.yml'
    parameters:
      StackAction: ${{ parameters.StackAction }}
      regionName: ${{ parameters.regionName }}
      S3BucketStackName: ${{ variables.S3BucketStackName }}
      VpcStackName: ${{ variables.VpcStackName }}
      SecurityGroupStackName: ${{ variables.SecurityGroupStackName }}
      AlbStackName: ${{ variables.AlbStackName }}
      IamStackName: ${{ variables.IamStackName }}
      AsgStackName: ${{ variables.AsgStackName }}
      S3BucketName: ${{ variables.S3BucketName }}
